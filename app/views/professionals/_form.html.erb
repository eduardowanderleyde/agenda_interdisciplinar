<div class="max-w-4xl mx-auto bg-white/10 backdrop-blur-md rounded-3xl border border-white/20 shadow-xl p-10 space-y-12 text-white">
  <% if @professional.errors.any? %>
    <div class="mb-4 p-4 bg-red-100 text-red-800 rounded">
      <ul class="list-disc pl-5">
        <% @professional.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= simple_form_for(@professional) do |f| %>
    <div class="form-inputs space-y-8">
      <div>
        <%= f.input :name,
          input_html: {
            class: 'w-full px-4 py-3 rounded-xl bg-white/80 text-gray-900 placeholder-gray-500 shadow-inner focus:ring-2 focus:ring-indigo-400 focus:outline-none'
          },
          label_html: {
            class: 'block text-lg font-bold text-indigo-100 mb-3'
          } %>
      </div>

      <div>
        <label class="block text-lg font-bold text-indigo-100 mb-3">Especialidades</label>
        <div class="flex flex-wrap gap-4 mb-2">
          <% Specialty.all.each do |spec| %>
            <label class="inline-flex items-center mb-2">
              <%= check_box_tag 'professional[specialty_ids][]', spec.id, @professional.specialty_ids.include?(spec.id),
                class: 'form-checkbox h-5 w-5 text-indigo-400 bg-white/20 border-white/30 rounded focus:ring-2 focus:ring-indigo-300' %>
              <span class="ml-2 text-white text-sm"><%= spec.name %></span>
            </label>
          <% end %>
        </div>
      </div>

      <div data-controller="horarios">
        <label class="block text-lg font-bold text-indigo-100 mb-4">Horários disponíveis por dia</label>
        <p class="text-sm text-indigo-200 mb-4">Preencha <b>início</b> e <b>fim</b> para adicionar um intervalo. Exemplo: 12:00 até 14:00</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <% dias_semana = [
            ['monday', 'Segunda'],
            ['tuesday', 'Terça'],
            ['wednesday', 'Quarta'],
            ['thursday', 'Quinta'],
            ['friday', 'Sexta']
          ] %>

          <% dias_semana.each do |dia_key, dia_label| %>
            <div class="p-4 bg-white/20 rounded-xl shadow flex flex-col gap-2">
              <div class="flex items-center gap-2">
                <input type="checkbox" name="professional[available_days][]" value="<%= dia_key %>"
                  <%= @professional.available_days&.include?(dia_key) ? 'checked' : '' %>
                  class="form-checkbox h-5 w-5 text-indigo-400 bg-white/20 border-white/30 rounded focus:ring-2 focus:ring-indigo-300">
                <label class="font-bold text-indigo-100 text-base"><%= dia_label %></label>
              </div>

              <div class="flex flex-wrap items-center gap-2">
                <input type="text" data-dia="<%= dia_key %>" maxlength="5" placeholder="Início (Ex: 12:00)"
                  class="w-24 p-2 rounded-lg text-sm bg-white/80 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 shadow-inner js-inicio"
                  autocomplete="off">
                <span class="font-bold text-white">até</span>
                <input type="text" data-dia="<%= dia_key %>" maxlength="5" placeholder="Fim (Ex: 14:00)"
                  class="w-24 p-2 rounded-lg text-sm bg-white/80 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 shadow-inner js-fim"
                  autocomplete="off">
                <button type="button" id="btn-adicionar-<%= dia_key %>"
                  class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition text-xs font-semibold shadow ml-2">
                  Adicionar horário (JS)
                </button>
              </div>

              <ul id="lista-horarios-<%= dia_key %>" class="mt-2 flex flex-wrap gap-2">
                <% ah = @professional.available_hours
                   if ah.is_a?(String)
                     begin
                       ah = JSON.parse(ah) rescue {}
                     rescue
                       ah = {}
                     end
                   end
                   if ah.is_a?(Array)
                     ah = { "all_days" => ah }
                   end
                   ah = {} unless ah.is_a?(Hash)
                   lista = Array(ah[dia_key])
                %>
                <% lista.each do |intervalo| %>
                  <li class="flex items-center bg-green-100 text-green-900 rounded px-3 py-1 mb-1 font-semibold text-xs shadow-sm">
                    <span><%= intervalo %></span>
                    <input type="hidden" name="professional[available_hours][<%= dia_key %>][]" value="<%= intervalo %>">
                    <button type="button" onclick="this.parentElement.remove()" class="ml-2 text-red-600 hover:text-red-800 font-bold text-lg bg-transparent border-none cursor-pointer">&times;</button>
                  </li>
                <% end %>
              </ul>

                <script>
                  document.addEventListener('DOMContentLoaded', function () {
                    var btn = document.getElementById('btn-adicionar-<%= dia_key %>');
                    var lista = document.getElementById('lista-horarios-<%= dia_key %>');
                    btn.onclick = function () {
                      var inicio = document.querySelector('input.js-inicio[data-dia="<%= dia_key %>"]').value.trim();
                      var fim = document.querySelector('input.js-fim[data-dia="<%= dia_key %>"]').value.trim();

                      console.log(inicio, fim);
                      if (!inicio || !fim) {
                        alert('Preencha início e fim!');
                        return;
                      }

                      // Formata o intervalo como "início - fim"
                      var texto = inicio + ' - ' + fim;

                      // Verifica se o intervalo já existe na lista
                      var horariosExistentes = Array.from(lista.querySelectorAll('li span')).map(function(span) {
                        return span.textContent.trim();
                      });

                      // Verificação de sobreposição
                      var conflito = horariosExistentes.some(function(intervalo) {
                        var [existeInicio, existeFim] = intervalo.split(' - ');
                        return (inicio < existeFim && fim > existeInicio); // Verifica se há interseção de horários
                      });

                      if (conflito) {
                        alert('Este intervalo se sobrepõe com outro existente!');
                        return;
                      }

                      // Se o intervalo não for duplicado, adiciona à lista
                      var li = document.createElement('li');
                      li.className = 'flex items-center bg-green-100 text-green-900 rounded px-3 py-1 mb-1 font-semibold text-xs shadow-sm';
                      li.innerHTML = `<span>${texto}</span>
                        <input type="hidden" name="professional[available_hours][<%= dia_key %>][]" value="${texto}">
                        <button type="button" onclick="this.parentElement.remove()" class="ml-2 text-red-600 hover:text-red-800 font-bold text-lg bg-transparent border-none cursor-pointer">&times;</button>`;
                      lista.appendChild(li);

                      // Limpa os campos de entrada de horário
                      document.querySelector('input.js-inicio[data-dia="<%= dia_key %>"]').value = '';
                      document.querySelector('input.js-fim[data-dia="<%= dia_key %>"]').value = '';
                    };
                  });
                </script>

            </div>
          <% end %>
        </div>
        <small class="text-indigo-200 block mt-2">Digite o horário de início e fim no formato 12:00, 14:00. O intervalo será salvo ao criar o profissional.</small>
      </div>

      <div class="mt-6">
        <label class="block text-lg font-bold text-indigo-100 mb-3">Duração padrão da sessão</label>
        <%= f.select :default_session_duration,
            options_for_select([["30 minutos", 30], ["45 minutos", 45], ["60 minutos", 60]], @professional.default_session_duration),
            {},
            class: "block w-48 p-2 border rounded bg-white/90 text-gray-800" %>
      </div>
    </div>

    <div class="form-actions flex justify-end pt-8">
      <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold shadow">
        Criar novo Profissional
      </button>
    </div>
  <% end %>
</div>
