<style>
  .calendar-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    overflow: hidden;
  }
  .calendar-table th, .calendar-table td {
    border: 1px solid #ececec;
    text-align: left;
    padding: 0;
    min-width: 120px;
    height: 40px;
    position: relative;
  }
  .calendar-table th {
    background: #f8fafc;
    font-weight: 600;
    font-size: 1rem;
    color: #2d3748;
    text-align: center;
    height: 40px;
  }
  .calendar-time-col {
    width: 60px;
    background: #f8fafc;
    color: #6b7280;
    font-size: 0.95rem;
    text-align: right;
    padding-right: 8px;
    border-right: 1px solid #ececec;
  }
  .calendar-event {
    position: absolute;
    left: 8px;
    right: 8px;
    top: 4px;
    background: #fbbf24;
    color: #222;
    border-radius: 8px;
    padding: 6px 10px;
    font-size: 0.98rem;
    box-shadow: 0 1px 4px rgba(0,0,0,0.07);
    z-index: 2;
    min-height: 32px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    cursor: pointer;
    transition: box-shadow 0.2s;
  }
  .calendar-event.green { background: #a7f3d0; color: #065f46; }
  .calendar-event.orange { background: #fdba74; color: #7c2d12; }
  .calendar-event:hover { box-shadow: 0 4px 16px rgba(99,102,241,0.15); }
  .calendar-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1em;
  }
  .calendar-nav a {
    background: #f1f5f9;
    color: #3b3b6d;
    padding: 6px 16px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 500;
    font-size: 1rem;
    transition: background 0.2s;
  }
  .calendar-nav a:hover {
    background: #e0e7ef;
  }
  .calendar-tooltip {
    display: none;
    position: absolute;
    left: 110%;
    top: 0;
    min-width: 220px;
    background: #222;
    color: #fff;
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 0.97rem;
    box-shadow: 0 2px 12px rgba(0,0,0,0.18);
    z-index: 10;
    white-space: pre-line;
  }
  .calendar-event:hover .calendar-tooltip {
    display: block;
  }
  .calendar-help {
    background: #f1f5f9;
    color: #3b3b6d;
    border-radius: 8px;
    padding: 12px 18px;
    margin-bottom: 18px;
    font-size: 1.05rem;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  }
</style>

<%# Gera horários de 08:00 até 18:00 de 30 em 30min %>
<% def time_slots(start_time = '08:00', end_time = '18:00', interval = 30)
     slots = []
     t = Time.zone.parse(start_time)
     end_t = Time.zone.parse(end_time)
     while t <= end_t
       slots << t.strftime('%H:%M')
       t += interval.minutes
     end
     slots
   end %>
<% hours = time_slots() %>

<div style="max-width: 900px; margin: 32px auto;">
  <h1 style="font-size:2rem; font-weight:700; color:#222; margin-bottom:0.2em;">Agenda Semanal do Profissional</h1>
  <div class="calendar-help">
    Visualize abaixo todos os agendamentos da semana para este profissional.<br>
    <b>Dica:</b> Passe o mouse sobre um agendamento para ver detalhes completos.<br>
    Use as setas para navegar entre as semanas.
  </div>
  <div style="color:#4b5563; font-size:1.1rem; margin-bottom:1em;">
    <b>Profissional:</b> <%= @professional.name %> <span style="font-size:0.95em; color:#6b7280;">(<%= @professional.specialty %>)</span>
  </div>
  <div class="calendar-nav">
    <%= link_to '← Semana anterior', schedule_professional_path(@professional, week: @prev_week), class: 'calendar-nav-link' %>
    <div style="color:#6b7280; font-size:1rem; font-weight:500;">
      <%= @week_days.first.strftime('%d/%m/%Y') %> até <%= @week_days.last.strftime('%d/%m/%Y') %>
    </div>
    <%= link_to 'Próxima semana →', schedule_professional_path(@professional, week: @next_week), class: 'calendar-nav-link' %>
  </div>
  <table class="calendar-table">
    <thead>
      <tr>
        <th>Horário</th>
        <% @week_days.each do |day| %>
          <th><%= I18n.l(day, format: '%A', locale: :'pt-BR') %><br><span style="font-size:0.95em; color:#888;"><%= day.strftime('%d/%m') %></span></th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% hours.each_with_index do |hour, i| %>
        <tr>
          <td class="calendar-time-col"><%= hour %></td>
          <% @week_days.each do |day| %>
            <td style="position:relative;">
              <% @appointments.each do |appt| %>
                <% appt_time = appt.start_time.strftime('%H:%M') %>
                <% appt_end = (appt.start_time + appt.duration.minutes).strftime('%H:%M') %>
                <% if appt.start_time.to_date == day && appt_time == hour %>
                  <% slot_span = (appt.duration / 30.0).round %>
                  <div class="calendar-event <%= appt.duration < 45 ? 'orange' : 'green' %>"
                       style="height: calc(40px * <%= slot_span %> + 4px * (<%= slot_span-1 %>)); top: 4px;">
                    <strong><%= appt.patient&.name || 'Paciente' %></strong>
                    <div style="font-size:0.95em;">
                      <%= appt.notes || appt.diagnosis || 'Sessão' %> <%= appt.duration %> min
                    </div>
                    <div class="calendar-tooltip">
                      <strong>Paciente:</strong> <%= appt.patient&.name || 'Paciente' %><br>
                      <strong>Data:</strong> <%= l(appt.start_time, format: :long, locale: :'pt-BR') %><br>
                      <strong>Duração:</strong> <%= appt.duration %> minutos<br>
                      <strong>Profissional:</strong> <%= @professional.name %><br>
                      <strong>Observações:</strong> <%= appt.notes || '-' %>
                    </div>
                  </div>
                <% end %>
              <% end %>
            </td>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>
</div> 