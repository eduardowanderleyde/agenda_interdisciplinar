<div class="max-w-2xl mx-auto mt-10 p-6 bg-white rounded shadow">
  <h1 class="text-2xl font-bold mb-4 text-indigo-700">Organizar Agenda</h1>
  <p class="mb-4">Selecione a semana, um profissional ou paciente para visualizar horários livres e salas disponíveis.</p>

  <%= form_with url: organizar_path, method: :get, local: true, class: "space-y-4 flex flex-col items-center" do |f| %>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
      <div>
        <label class="block font-semibold mb-1">Semana</label>
        <%= f.date_field :start_date, class: "border rounded p-2 w-full", value: params[:start_date] || Date.current.beginning_of_week(:monday).strftime('%Y-%m-%d') %>
      </div>
      <div>
        <label class="block font-semibold mb-1">Profissional</label>
        <%= f.select :professional_id, options_from_collection_for_select(@professionals, :id, :name, params[:professional_id]), { include_blank: "Todos" }, class: "border rounded p-2 w-full" %>
      </div>
      <div>
        <label class="block font-semibold mb-1">Paciente</label>
        <%= f.select :patient_id, options_from_collection_for_select(@patients, :id, :name, params[:patient_id]), { include_blank: "Todos" }, class: "border rounded p-2 w-full" %>
      </div>
      <div>
        <label class="block font-semibold mb-1">Sala</label>
        <%= f.select :room_id, options_from_collection_for_select(Room.all, :id, :name, params[:room_id]), { include_blank: "Todas" }, class: "border rounded p-2 w-full" %>
      </div>
    </div>
    <div class="flex flex-row justify-center gap-4 mt-4 w-full">
      <%= f.submit "Filtrar", class: "bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 font-semibold shadow" %>
      <%= button_to "Sugestão de Agendas", organizar_path(request.query_parameters.merge(sugerir_agenda: 1)), method: :get, class: "bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-semibold shadow", form_class: "inline" %>
    </div>
  <% end %>
</div>

<% if @agendas_sugeridas.present? %>
  <div class="max-w-3xl mx-auto mt-8 p-6 bg-white rounded shadow">
    <h2 class="text-xl font-bold mb-4 text-green-700">Sugestões de Agendas para a semana de <%= params[:start_date] %></h2>
    <% @agendas_sugeridas.each do |agenda| %>
      <div class="mb-6 p-4 border rounded bg-green-50">
        <h3 class="font-bold mb-2">Opção <%= agenda['opcao'] %>: <%= agenda['descricao'] %></h3>
        <table class="w-full text-xs mb-2">
          <thead>
            <tr class="border-b">
              <th class="text-left">Sala</th>
              <th class="text-left">Profissional</th>
              <th class="text-left">Paciente</th>
              <th class="text-left">Início</th>
              <th class="text-left">Fim</th>
            </tr>
          </thead>
          <tbody>
            <% agenda['slots'].each do |slot| %>
              <tr>
                <td><%= slot['sala'] %></td>
                <td><%= slot['profissional'] %></td>
                <td><%= slot['paciente'] %></td>
                <td><%= slot['inicio'] %></td>
                <td><%= slot['fim'] %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
        <%= form_with url: confirmar_agenda_path, method: :get, local: true do |f| %>
          <%= hidden_field_tag :agenda, agenda.to_json %>
          <%= f.submit "Confirmar esta Agenda", class: "bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700" %>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>

<% if @horarios_livres_profissional.present? %>
  <div class="max-w-2xl mx-auto mt-8 p-6 bg-white rounded shadow">
    <h2 class="text-xl font-bold mb-4 text-indigo-700">Horários livres para <%= @profissional.name %> na semana de <%= params[:start_date] %></h2>
    <table class="w-full text-sm mb-2">
      <thead>
        <tr class="border-b">
          <th class="text-left">Horário</th>
          <th class="text-left">Salas disponíveis</th>
          <th class="text-left">Paciente</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% @horarios_livres_profissional.each do |horario, salas| %>
          <tr>
            <td><%= horario %></td>
            <td>
              <%= form_with url: appointments_path, method: :post, local: true do |f| %>
                <%= hidden_field_tag :start_time, horario %>
                <%= hidden_field_tag :professional_id, @profissional.id %>
                <%= select_tag :room_id, options_for_select(Room.where(name: salas).pluck(:name, :id)), class: "border rounded p-1" %>
                <%= select_tag :duration, options_for_select([["30 min", 30], ["45 min", 45], ["60 min", 60]], 30), class: "border rounded p-1 ml-2" %>
            </td>
            <td>
                <%= select_tag :patient_id, options_from_collection_for_select(@patients, :id, :name), class: "border rounded p-1" %>
            </td>
            <td>
                <%= f.submit "Adicionar", class: "bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700" %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

<% if @horarios_livres_paciente.present? %>
  <div class="max-w-2xl mx-auto mt-8 p-6 bg-white rounded shadow">
    <h2 class="text-xl font-bold mb-4 text-green-700">Horários livres para <%= @paciente.name %> na semana de <%= params[:start_date] %></h2>
    <table class="w-full text-sm mb-2">
      <thead>
        <tr class="border-b">
          <th class="text-left">Horário</th>
          <th class="text-left">Profissionais disponíveis</th>
          <th class="text-left">Salas disponíveis</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% @horarios_livres_paciente.each do |horario, dados| %>
          <tr>
            <td><%= horario %></td>
            <td>
              <%= form_with url: appointments_path, method: :post, local: true do |f| %>
                <%= hidden_field_tag :start_time, horario %>
                <%= hidden_field_tag :patient_id, @paciente.id %>
                <%= select_tag :professional_id, options_for_select(Professional.where(name: dados[:profissionais]).pluck(:name, :id)), class: "border rounded p-1" %>
                <%= select_tag :duration, options_for_select([["30 min", 30], ["45 min", 45], ["60 min", 60]], 30), class: "border rounded p-1 ml-2" %>
            </td>
            <td>
                <%= select_tag :room_id, options_for_select(Room.where(name: dados[:salas]).pluck(:name, :id)), class: "border rounded p-1" %>
            </td>
            <td>
                <%= f.submit "Adicionar", class: "bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700" %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

<% if params[:start_date].present? %>
  <% dias = (0..6).map { |i| Date.parse(params[:start_date]) + i.days } %>
  <% salas = Room.all %>
  <div class="max-w-7xl mx-auto mt-8">
    <h2 class="text-2xl font-bold mb-6 text-indigo-700">Planner Semanal por Sala</h2>
    <% salas.each do |sala| %>
      <div class="mb-10">
        <h3 class="text-lg font-bold mb-2 text-green-700">Sala: <%= sala.name %></h3>
        <table class="w-full table-auto border-collapse bg-white rounded shadow">
          <thead>
            <tr>
              <% dias.each do |dia| %>
                <th class="border p-2 bg-green-200">
                  <div class="font-bold"><%= I18n.l(dia, format: '%A') %></div>
                  <div><%= I18n.l(dia, format: '%d/%m') %></div>
                </th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <tr>
              <% dias.each do |dia| %>
                <td class="border align-top p-2">
                  <% ags = (@agendamentos_por_sala_e_dia && @agendamentos_por_sala_e_dia.dig(sala.id, dia)) || [] %>
                  <% if ags.any? %>
                    <% ags.each do |ag| %>
                      <div class="mb-2 p-1 rounded bg-indigo-50 border-l-4 border-indigo-400 shadow text-xs">
                        <div><b><%= ag[:hora] %></b> - <%= ag[:profissional] %></div>
                        <div><%= ag[:paciente] %></div>
                      </div>
                    <% end %>
                  <% else %>
                    <span class="text-gray-400 text-xs">Sem agendamento</span>
                  <% end %>
                </td>
              <% end %>
            </tr>
          </tbody>
        </table>
      </div>
    <% end %>
  </div>
<% end %>
