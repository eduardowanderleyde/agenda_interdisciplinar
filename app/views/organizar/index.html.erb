<div class="max-w-4xl mx-auto mt-10">
  <div class="bg-white rounded-xl shadow p-6 flex flex-col gap-6">
    <!-- Seleção de data -->
    <%= form_with url: organizar_path, method: :get, local: true, html: { id: 'data-select-form' } do |f| %>
      <div class="flex flex-col md:flex-row md:items-end gap-4">
        <div class="flex flex-row items-end gap-2">
          <div>
            <label class="block font-semibold mb-1">Semana</label>
            <%= f.date_field :start_date, class: "border rounded p-2 w-full min-w-[160px]", value: params[:start_date] || Date.current.strftime('%Y-%m-%d') %>
          </div>
          <div>
            <%= f.submit "Selecionar", class: "bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 font-semibold shadow" %>
          </div>
        </div>
      </div>
    <% end %>

    <% if params[:start_date].present? %>
      <!-- Dropdown de paciente sem agendamento -->
      <%= form_with url: organizar_path, method: :get, local: true, html: { id: 'paciente-select-form' } do |f| %>
        <%= hidden_field_tag :start_date, params[:start_date] %>
        <div class="flex flex-col md:flex-row md:items-end gap-4">
          <div class="flex-1">
            <label class="block font-semibold mb-1">Paciente sem agendamento</label>
            <select class="border rounded p-2 w-full" name="paciente_sem_agendamento" onchange="this.form.submit()">
              <option value="">Selecione um paciente</option>
              <% Patient.all.each do |pac| %>
                <option value="<%= pac.id %>" <%= 'selected' if params[:paciente_sem_agendamento].to_s == pac.id.to_s %>><%= pac.name %></option>
              <% end %>
            </select>
          </div>
        </div>
      <% end %>
    <% end %>

    <% if params[:paciente_sem_agendamento].present? %>
      <!-- Dropdown de área/especialidade do paciente -->
      <%= form_with url: organizar_path, method: :get, local: true, html: { id: 'especialidade-select-form' } do |f| %>
        <%= hidden_field_tag :start_date, params[:start_date] %>
        <%= hidden_field_tag :paciente_sem_agendamento, params[:paciente_sem_agendamento] %>
        <div class="flex flex-col md:flex-row md:items-end gap-4">
          <div class="flex-1">
            <label class="block font-semibold mb-1">Área da sessão</label>
            <select class="border rounded p-2 w-full" name="especialidade_id" onchange="this.form.submit()">
              <option value="">Selecione uma especialidade</option>
              <% Specialty.all.each do |spec| %>
                <option value="<%= spec.id %>" <%= 'selected' if params[:especialidade_id].to_s == spec.id.to_s %>><%= spec.name %></option>
              <% end %>
            </select>
          </div>
        </div>
      <% end %>
    <% end %>

    <% if params[:especialidade_id].present? %>
      <!-- Dropdown de horário desejado -->
      <%= form_with url: organizar_path, method: :get, local: true, html: { id: 'horario-select-form' } do |f| %>
        <%= hidden_field_tag :start_date, params[:start_date] %>
        <%= hidden_field_tag :paciente_sem_agendamento, params[:paciente_sem_agendamento] %>
        <%= hidden_field_tag :especialidade_id, params[:especialidade_id] %>
        <div class="flex flex-col md:flex-row md:items-end gap-4">
          <div class="flex-1">
            <label class="block font-semibold mb-1">Horário desejado</label>
            <select class="border rounded p-2 w-full" name="horario_desejado">
              <option value="">Selecione um horário</option>
              <% week_start = Date.parse(params[:start_date]) rescue nil %>
              <% week_end = week_start + 6.days if week_start %>
              <% horarios = [] %>
              <% if week_start && week_end %>
                <% (week_start..week_end).each do |dia| %>
                  <% (8..17).each do |h| %>
                    <% [0, 15, 30, 45].each do |min| %>
                      <% hora = "%02d:%02d" % [h, min] %>
                      <option value="<%= dia %>|<%= hora %>" <%= 'selected' if params[:horario_desejado] == "#{dia}|#{hora}" %>><%= I18n.l(dia, format: '%A', locale: :'pt-BR') %> - <%= dia.strftime('%d/%m') %> - <%= hora %></option>
                    <% end %>
                  <% end %>
                  <option value="<%= dia %>|18:00" <%= 'selected' if params[:horario_desejado] == "#{dia}|18:00" %>><%= I18n.l(dia, format: '%A', locale: :'pt-BR') %> - <%= dia.strftime('%d/%m') %> - 18:00</option>
                <% end %>
              <% end %>
            </select>
          </div>
        </div>
        <div class="mt-4">
          <%= hidden_field_tag :sugerir_agenda_semana, 1 %>
          <%= f.submit "Sugerir profissional", class: "bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-semibold shadow w-full" %>
        </div>
      <% end %>
    <% end %>

    <% if @profissionais_sugeridos.present? %>
      <div class="bg-white rounded-xl shadow p-6 flex flex-col gap-4 max-w-2xl mx-auto mt-4 relative overflow-visible">
        <label class="block font-semibold mb-1">Profissional sugerido</label>
        <%= form_with url: appointments_path, method: :post, local: true do |f| %>
          <%= hidden_field_tag "appointment[patient_id]", params[:paciente_sem_agendamento] %>
          <%= hidden_field_tag "appointment[start_time]", params[:horario_desejado].split('|').join(' ') %>
          <%= hidden_field_tag "appointment[duration]", 15 %>
          <div class="flex gap-2 flex-col md:flex-row items-center">
            <select name="appointment[professional_id]" id="profissional-select" class="border rounded p-2 min-w-[180px]" required>
              <option value="">Selecione o profissional</option>
              <% @profissionais_sugeridos.each do |prof| %>
                <option value="<%= prof.id %>"><%= prof.name %></option>
              <% end %>
            </select>
            <select name="appointment[room_id]" id="sala-select" class="border rounded p-2 min-w-[140px]" required>
              <option value="">Selecione a sala</option>
              <% week_start = Date.parse(params[:start_date]) rescue nil %>
              <% dia = params[:horario_desejado]&.split('|')&.first %>
              <% hora = params[:horario_desejado]&.split('|')&.last %>
              <% inicio = (dia && hora) ? Time.zone.parse("#{dia} #{hora}") : nil %>
              <% fim = inicio ? inicio + 15.minutes : nil %>
              <% Room.all.each do |sala| %>
                <% ocupado = inicio && fim && Appointment.where(room: sala).where("start_time < ? AND (start_time + interval '1 minute' * duration) > ?", fim, inicio).exists? %>
                <% unless ocupado %>
                  <option value="<%= sala.id %>"><%= sala.name %></option>
                <% end %>
              <% end %>
            </select>
            <%= f.submit 'Adicionar na agenda', class: 'bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700 text-xs' %>
          </div>
        <% end %>
      </div>
    <% elsif params[:sugerir_agenda_semana].present? %>
      <div class="text-red-600 text-sm mt-2">Nenhum profissional disponível para este horário/especialidade.</div>
    <% end %>
  </div>
</div>

<!-- Planner semanal -->
<div class="w-full min-h-screen bg-gray-50 py-8">
  <div class="max-w-7xl mx-auto">
    <h2 class="text-2xl font-bold mb-6 text-indigo-700">Planner Semanal por Sala</h2>
    <% if params[:start_date].present? %>
      <% dias = (0..6).map { |i| Date.parse(params[:start_date]) + i.days } %>
      <% horarios = (8..17).flat_map { |h| ["%02d:00" % h, "%02d:30" % h] } + ["18:00"] %>
      <% @rooms.each_with_index do |sala, idx| %>
        <div class="mb-10">
          <h3 class="text-2xl font-extrabold mb-2 text-green-700 uppercase tracking-wide">SALA <%= idx+1 %></h3>
          <table class="w-full table-fixed border-collapse bg-white rounded shadow">
            <thead>
              <tr>
                <th class="border p-2 bg-green-200 w-1/12 min-w-[80px]">Horário</th>
                <% dias.each do |dia| %>
                  <th class="border p-2 bg-green-200 w-1/7 min-w-[140px] max-w-[180px]">
                    <div class="font-bold text-indigo-800 text-base">
                      <%= I18n.l(dia, format: '%A', locale: :'pt-BR') %> <%= dia.strftime('%d/%m') %>
                    </div>
                  </th>
                <% end %>
              </tr>
            </thead>
            <tbody>
              <% horarios.each do |hora| %>
                <tr>
                  <td class="border p-2 font-bold bg-green-50"><%= hora %></td>
                  <% dias.each do |dia| %>
                    <% ag = @appointments.find { |a| a.room_id == sala.id && a.start_time.to_date == dia && a.start_time.strftime('%H:%M') == hora } %>
                    <td class="border align-top p-2">
                      <% if ag %>
                        <div class="mb-2 px-4 py-4 rounded-xl bg-white border border-indigo-100 shadow flex flex-col items-center text-xs gap-2 transition hover:shadow-lg min-h-[90px] justify-center">
                          <div class="font-bold text-base text-indigo-700 mb-1">
                            <%= I18n.l(ag.start_time, format: '%A') %> <%= ag.start_time.strftime('%H:%M') %>
                          </div>
                          <div class="text-gray-900 font-semibold text-sm text-center">
                            Paciente: <span class="font-normal"><%= ag.patient&.name %></span>
                          </div>
                          <div class="text-gray-900 font-semibold text-sm text-center">
                            Profissional: <span class="font-normal"><%= ag.professional&.name %></span>
                          </div>
                          <% if ag.specialty.present? %>
                            <div class="text-indigo-600 font-semibold text-xs text-center bg-indigo-50 rounded px-2 py-1 mt-1">
                              Sessão: <%= ag.specialty.name %>
                            </div>
                          <% end %>
                        </div>
                      <% else %>
                        <span class="text-gray-400 text-xs flex items-center justify-center min-h-[90px] h-full w-full">Livre</span>
                      <% end %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<% if @agendas_sugeridas.present? %>
  <div class="max-w-3xl mx-auto mt-8 p-6 bg-white rounded shadow">
    <h2 class="text-xl font-bold mb-4 text-green-700">Sugestões de Agendas para a semana de <%= params[:start_date] %></h2>
    <% @agendas_sugeridas.each do |agenda| %>
      <div class="mb-6 p-4 border rounded bg-green-50">
        <h3 class="font-bold mb-2">Opção <%= agenda['opcao'] %>: <%= agenda['descricao'] %></h3>
        <table class="w-full text-xs mb-2">
          <thead>
            <tr class="border-b">
              <th class="text-left">Sala</th>
              <th class="text-left">Profissional</th>
              <th class="text-left">Paciente</th>
              <th class="text-left">Início</th>
              <th class="text-left">Fim</th>
            </tr>
          </thead>
          <tbody>
            <% agenda['slots'].each do |slot| %>
              <tr>
                <td><%= slot['sala'] %></td>
                <td><%= slot['profissional'] %></td>
                <td><%= slot['paciente'] %></td>
                <td><%= slot['inicio'] %></td>
                <td><%= slot['fim'] %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
        <%= form_with url: confirmar_agenda_path, method: :get, local: true do |f| %>
          <%= hidden_field_tag :agenda, agenda.to_json %>
          <%= f.submit "Confirmar esta Agenda", class: "bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700" %>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>

<%# Exibir erros de agendamento, se houver %>
<% if flash[:alert].present? %>
  <div class="max-w-2xl mx-auto mt-4 mb-4 p-4 bg-red-100 border border-red-400 text-red-800 rounded shadow">
    <strong>Erro ao agendar:</strong>
    <% if flash[:alert].is_a?(Array) %>
      <select class="block w-full mt-2 border border-red-400 rounded p-2 bg-white text-red-800">
        <% flash[:alert].each do |erro| %>
          <option><%= erro %></option>
        <% end %>
      </select>
    <% else %>
      <div class="mt-2"><%= flash[:alert] %></div>
    <% end %>
  </div>
<% end %>

<% if @horarios_livres_profissional.present? %>
  <div class="max-w-2xl mx-auto mt-8 p-6 bg-white rounded shadow">
    <h2 class="text-xl font-bold mb-4 text-indigo-700">Horários livres para <%= @profissional.name %> na semana de <%= params[:start_date] %></h2>
    <table class="w-full text-sm mb-2">
      <thead>
        <tr class="border-b">
          <th class="text-left">Horário</th>
          <th class="text-left">Salas disponíveis</th>
          <th class="text-left">Paciente</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% @horarios_livres_profissional.each do |horario, salas| %>
          <% hora = horario.split.last %>
          <tr>
            <td><%= horario %></td>
            <td>
              <%= form_with url: appointments_path, method: :post, local: true do |f| %>
                <%= hidden_field_tag :start_time, Date.parse(params[:start_date]).strftime('%Y-%m-%d') + ' ' + hora %>
                <%= hidden_field_tag :professional_id, @profissional.id %>
                <%= select_tag :room_id, options_for_select(Room.where(name: salas).pluck(:name, :id)), class: "border rounded p-1" %>
                <%= select_tag :duration, options_for_select([["30 min", 30], ["45 min", 45], ["60 min", 60]], 30), class: "border rounded p-1 ml-2" %>
            </td>
            <td>
                <%= select_tag :patient_id, options_from_collection_for_select(@patients, :id, :name), class: "border rounded p-1" %>
            </td>
            <td>
                <%= f.submit "Adicionar", class: "bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700" %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

<% if @horarios_livres_paciente.present? %>
  <div class="max-w-2xl mx-auto mt-8 p-6 bg-white rounded shadow">
    <h2 class="text-xl font-bold mb-4 text-green-700">Horários livres para <%= @paciente.name %> na semana de <%= params[:start_date] %></h2>
    <table class="w-full text-sm mb-2">
      <thead>
        <tr class="border-b">
          <th class="text-left">Horário</th>
          <th class="text-left">Profissionais disponíveis</th>
          <th class="text-left">Salas disponíveis</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% @horarios_livres_paciente.each do |horario, dados| %>
          <% hora = horario.split.last %>
          <tr>
            <td><%= horario %></td>
            <td>
              <%= form_with url: appointments_path, method: :post, local: true do |f| %>
                <%= hidden_field_tag :start_time, Date.parse(params[:start_date]).strftime('%Y-%m-%d') + ' ' + hora %>
                <%= hidden_field_tag :patient_id, @paciente.id %>
                <%= select_tag :professional_id, options_for_select(Professional.where(name: dados[:profissionais]).pluck(:name, :id)), class: "border rounded p-1" %>
                <%= select_tag :duration, options_for_select([["30 min", 30], ["45 min", 45], ["60 min", 60]], 30), class: "border rounded p-1 ml-2" %>
            </td>
            <td>
                <%= select_tag :room_id, options_for_select(Room.where(name: dados[:salas]).pluck(:name, :id)), class: "border rounded p-1" %>
            </td>
            <td>
                <%= f.submit "Adicionar", class: "bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700" %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>
