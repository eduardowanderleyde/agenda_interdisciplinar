<% dias = params[:start_date].present? ? (0..6).map { |i| Date.parse(params[:start_date]) + i.days } : [] %>

<div class="min-h-screen bg-gradient-to-br from-indigo-700 via-purple-600 to-blue-400 py-12 px-4" data-controller="organizar">
  <div class="max-w-7xl mx-auto space-y-12">

    <!-- Formulário de busca de disponibilidade Paciente-Profissional -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-2 max-w-xl mx-auto">
      <h2 class="text-2xl font-extrabold text-center mb-4 text-indigo-800">Buscar disponibilidade Paciente-Profissional</h2>
      <%= form_with url: organizar_path, method: :get, local: true, html: { class: "space-y-4 flex flex-col items-center" } do |f| %>
        <div class="w-full">
          <label for="patient_id" class="block font-semibold mb-1 text-indigo-700">Selecione o paciente</label>
          <%= f.collection_select :patient_id, Patient.order(:name), :id, :name, {prompt: "Selecione"}, class: "w-full rounded-xl p-3 border border-gray-300" %>
        </div>
        <div class="w-full">
          <label class="block text-sm font-medium text-gray-700">Data</label>
          <%= f.date_field :start_date, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", value: params[:start_date] || Date.current.strftime('%Y-%m-%d') %>
        </div>
        <div class="w-full">
          <label class="block text-sm font-medium text-gray-700">Especialidade</label>
          <select name="especialidade_id" id="especialidade_id" class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            <% if @especialidades_paciente.present? %>
              <optgroup label="Especialidades do paciente">
                <% @especialidades_paciente.each do |e| %>
                  <option value="<%= e.id %>" <%= 'selected' if params[:especialidade_id].to_s == e.id.to_s %>><%= e.name %></option>
                <% end %>
              </optgroup>
            <% end %>
            <% outras = Specialty.where.not(id: (@especialidades_paciente || []).map(&:id)) %>
            <% if outras.any? %>
              <optgroup label="Outras especialidades">
                <% outras.each do |e| %>
                  <option value="<%= e.id %>" <%= 'selected' if params[:especialidade_id].to_s == e.id.to_s %>><%= e.name %></option>
                <% end %>
              </optgroup>
            <% end %>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Horário</label>
          <%= f.select :horario, options_for_select(['08:00', '09:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00'], params[:horario]), class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
        </div>
        <div class="w-full flex justify-center">
          <%= f.submit "Buscar disponibilidade", class: "bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold shadow hover:bg-indigo-700 transition" %>
        </div>
      <% end %>
      <% if params[:patient_id].present? && params[:start_date].present? %>
        <div class="text-center text-lg text-red-600 font-bold mt-4 mb-2 bg-yellow-100 rounded-xl p-4 border border-yellow-300 shadow">
          <% if @profissionais_disponiveis.present? && @profissionais_disponiveis.empty? %>
            Não há profissionais disponíveis para este paciente/data/horário.<br>
            <span class="text-sm text-gray-700">Veja abaixo o motivo para cada profissional checado.</span>
          <% elsif @profissionais_disponiveis.present? %>
            Encontramos <%= @profissionais_disponiveis.size %> profissionais disponíveis em <%= @total_profissionais_checados %> profissionais checados.
          <% else %>
            Não há profissionais disponíveis para este paciente/data/horário.<br>
            <span class="text-sm text-gray-700">Veja abaixo o motivo para cada profissional checado.</span>
          <% end %>
          <% if @profissionais_disponiveis.present? && @profissionais_disponiveis.any? %>
            <div class="mt-2 text-base text-indigo-900 font-semibold">
              Profissionais disponíveis:<br>
              <ul class="list-disc list-inside mt-1">
                <% @profissionais_disponiveis.each do |prof| %>
                  <li><%= prof.name %></li>
                <% end %>
              </ul>
            </div>
          <% end %>
        </div>
        <% if @checagem_profissionais.present? %>
          <div class="mt-4 bg-white rounded-xl p-4 border border-gray-200 shadow">
            <h3 class="font-bold text-indigo-800 mb-2">Profissionais checados:</h3>
            <ul class="list-disc list-inside">
              <% @checagem_profissionais.each do |prof| %>
                <li>
                  <span class="font-semibold"><%= prof[:nome] %></span>
                  <% if prof[:disponivel] %>
                    <span class="text-green-600 font-bold">(Disponível)</span>
                  <% else %>
                    <span class="text-red-600">(Descartado: <%= prof[:motivos].join(', ') %>)</span>
                  <% end %>
                </li>
              <% end %>
            </ul>
          </div>
        <% end %>
      <% end %>
    </div>

    <!-- Cabeçalho: Seletor de semana -->
    <div class="flex flex-wrap gap-6 items-end justify-between">
      <%= form_with url: organizar_path, method: :get, local: true, html: { class: "flex flex-wrap gap-4 items-end" } do |f| %>
        <div>
          <label for="start_date" class="block text-white font-semibold text-lg mb-1">Semana</label>
          <%= f.date_field :start_date, class: "rounded-xl p-3 text-base bg-white/90 text-gray-800 shadow-inner", value: params[:start_date] || Date.current.strftime('%Y-%m-%d') %>
        </div>
        <div>
          <label class="block h-5"></label>
          <%= f.submit "Selecionar", class: "bg-indigo-600 text-white px-6 py-3 rounded-xl font-semibold shadow hover:bg-indigo-700 transition text-lg" %>
        </div>
        <div>
          <label class="block h-5"></label>
          <%= link_to "Atualizar agendamentos", organizar_path(start_date: params[:start_date]), class: "bg-blue-500 text-white px-6 py-3 rounded-xl font-semibold shadow hover:bg-blue-700 transition text-lg ml-2" %>
        </div>
      <% end %>
      <h2 class="text-3xl font-bold text-white drop-shadow">HORÁRIO OFICIAL - Planner Semanal por Sala</h2>
    </div>

    <!-- Tabelas -->
    <% if dias.any? %>
      <% horarios = []; t = Time.zone.parse('07:00'); while t <= Time.zone.parse('19:00'); horarios << t.strftime('%H:%M'); t += 15.minutes; end %>
      <% @rooms.each_with_index do |sala, idx| %>
        <% agendamentos_sala = @appointments.where(room_id: sala.id) %>
        <% agendamentos_na_grade = @grades_por_sala[sala.id].values.map { |h| h.values }.flatten.compact.size %>
        <div class="mb-2 text-center">
          <span class="inline-block bg-blue-100 text-blue-900 rounded-xl px-4 py-2 font-semibold shadow">
            Agendamentos cadastrados para <b>Sala <%= sala.name %></b>: <%= agendamentos_sala.size %> | Exibidos na grade: <%= agendamentos_na_grade %>
          </span>
        </div>
        <div class="space-y-6">
          <h3 class="text-2xl font-extrabold text-center text-green-200 uppercase tracking-wide bg-white/10 py-2 rounded-xl shadow">SALA <%= sala.name %></h3>
          <%= render partial: 'suggestions/simulacao_grade', locals: {
            grade: @grades_por_sala[sala.id],
            week_days: dias,
            hours: horarios,
            rooms: [sala],
            tabela_tipo: 'atual',
            selected_room: sala
          } %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<!-- Modal de Adicionar Agendamento -->
<div data-controller="planner" data-planner-target="modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-8 shadow-xl w-full max-w-md relative">
    <button type="button" class="absolute top-2 right-2 text-gray-400 hover:text-red-600 text-2xl" data-action="click->planner#close">&times;</button>
    <h2 class="text-xl font-bold mb-4 text-indigo-700">Adicionar Agendamento</h2>
    <%= form_with url: appointments_path, method: :post, local: true do |f| %>
      <%= f.hidden_field :room_id, data: { planner_target: "roomId" } %>
      <div class="mb-4">
        <%= f.label :start_time, "Data e Hora", class: "block font-semibold mb-1" %>
        <%= f.text_field :start_time, class: "w-full rounded p-2 border", data: { planner_target: "startTime" } %>
      </div>
      <!-- Campos adicionais -->
      <div class="mb-4">
        <%= f.label :patient_id, "Paciente", class: "block font-semibold mb-1" %>
        <%= f.collection_select :patient_id, Patient.order(:name), :id, :name, {prompt: "Selecione"}, class: "w-full rounded p-2 border" %>
      </div>
      <div class="mb-4">
        <%= f.label :professional_id, "Profissional", class: "block font-semibold mb-1" %>
        <%= f.collection_select :professional_id, Professional.order(:name), :id, :name, {prompt: "Selecione"}, class: "w-full rounded p-2 border" %>
      </div>
      <div class="mb-4">
        <%= f.label :specialty_id, "Especialidade", class: "block font-semibold mb-1" %>
        <%= f.collection_select :specialty_id, Specialty.order(:name), :id, :name, {prompt: "Selecione"}, class: "w-full rounded p-2 border" %>
      </div>
      <div class="text-center">
        <%= f.submit "Salvar", class: "bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-bold" %>
      </div>
    <% end %>
  </div>
</div>
