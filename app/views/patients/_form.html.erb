<main class="flex justify-center items-center min-h-[80vh]">
  <div class="w-full max-w-2xl bg-card rounded-card shadow-card p-10 space-y-10">

    <% if @patient.errors.any? %>
      <div class="mb-6 p-4 bg-red-200/80 text-red-900 rounded-lg border border-red-400 shadow">
        <ul class="list-disc pl-5">
          <% @patient.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <h1 class="text-4xl font-extrabold text-center text-primary drop-shadow-lg tracking-tight mb-8">Cadastro de Pacientes</h1>

    <%= simple_form_for(@patient) do |f| %>
      <div class="space-y-12">
        <!-- Dados pessoais -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
          <div>
            <%= f.label :name, 'Nome', class: 'block font-semibold mb-1 text-primary' %>
            <%= f.input_field :name, class: 'form-input w-full rounded-card bg-card text-gray-900 placeholder-gray-400 focus:border-primary focus:ring-2 focus:ring-primary shadow-card' %>
          </div>
          <div>
            <%= f.label :birthdate, 'Data de Nascimento', class: 'block font-semibold mb-1 text-primary' %>
            <%= f.input_field :birthdate, type: 'date', class: 'form-input w-full rounded-card bg-card text-gray-900 placeholder-gray-400 focus:border-primary focus:ring-2 focus:ring-primary shadow-card' %>
          </div>
          <div>
            <%= f.label :diagnosis, 'Diagnóstico', class: 'block font-semibold mb-1 text-primary' %>
            <%= f.input_field :diagnosis, class: 'form-input w-full rounded-card bg-card text-gray-900 placeholder-gray-400 focus:border-secondary focus:ring-2 focus:ring-secondary shadow-card' %>
          </div>
          <div>
            <%= f.label :responsible, 'Responsável', class: 'block font-semibold mb-1 text-primary' %>
            <%= f.input_field :responsible, class: 'form-input w-full rounded-card bg-card text-gray-900 placeholder-gray-400 focus:border-secondary focus:ring-2 focus:ring-secondary shadow-card' %>
          </div>
        </div>

        <!-- Especialidades -->
        <div>
          <%= f.label :specialties, 'Especialidades Necessárias', class: 'block font-semibold mb-2 text-primary' %>
          <div class="flex flex-wrap gap-4 mt-2">
            <% Specialty.all.each do |specialty| %>
              <% checkbox_id = "patient_specialty_#{specialty.id}" %>
              <label for="<%= checkbox_id %>" class="flex items-center bg-gradient-to-r from-primary/80 to-secondary/80 text-white rounded-card px-3 py-2 text-sm font-semibold shadow-card hover:scale-105 transition-transform cursor-pointer">
                <%= check_box_tag 'patient[specialty_ids][]', specialty.id, @patient.specialty_ids.include?(specialty.id), id: checkbox_id, class: 'form-checkbox h-4 w-4 text-primary bg-card rounded mr-2 focus:ring-2 focus:ring-primary' %>
                <%= specialty.name %>
              </label>
            <% end %>
          </div>
        </div>

        <!-- Observações -->
        <div>
          <%= f.label :observations, 'Observações', class: 'block font-semibold mb-1 text-primary' %>
          <%= f.text_area :observations, class: 'form-textarea w-full rounded-card bg-card text-gray-900 placeholder-gray-400 focus:border-primary focus:ring-2 focus:ring-primary shadow-card', rows: 3, placeholder: 'Observações adicionais' %>
        </div>

        <!-- Horários disponíveis -->
        <div data-controller="horarios">
          <label class="block font-semibold mb-2 text-primary text-lg">Horários disponíveis por dia da semana</label>
          <p class="text-sm text-gray-600 mb-4">Preencha <b>início</b> e <b>fim</b> para adicionar um intervalo. Exemplo: 12:00 até 14:00</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <% dias_semana = [
              ['monday', 'Segunda-feira'],
              ['tuesday', 'Terça-feira'],
              ['wednesday', 'Quarta-feira'],
              ['thursday', 'Quinta-feira'],
              ['friday', 'Sexta-feira'],
              ['saturday', 'Sábado'],
              ['sunday', 'Domingo']
            ] %>
            <% dias_semana.each do |dia_key, dia_label| %>
              <div class="p-4 bg-white/40 rounded-xl shadow flex flex-col gap-2">
                <div class="flex items-center gap-2">
                  <input type="checkbox" name="patient[available_days][]" value="<%= dia_key %>"
                    <%= @patient.available_hours&.key?(dia_key) && @patient.available_hours[dia_key].present? ? 'checked' : '' %>
                    class="form-checkbox h-5 w-5 text-indigo-400 bg-white/20 border-white/30 rounded focus:ring-2 focus:ring-indigo-300">
                  <label class="font-bold text-primary text-base"><%= dia_label %></label>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                  <input type="text" data-dia="<%= dia_key %>" maxlength="5" placeholder="Início (Ex: 12:00)"
                    class="w-24 p-2 rounded-lg text-sm bg-white/80 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 shadow-inner js-inicio"
                    autocomplete="off">
                  <span class="font-bold text-primary">até</span>
                  <input type="text" data-dia="<%= dia_key %>" maxlength="5" placeholder="Fim (Ex: 14:00)"
                    class="w-24 p-2 rounded-lg text-sm bg-white/80 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 shadow-inner js-fim"
                    autocomplete="off">
                  <button type="button" id="btn-adicionar-<%= dia_key %>"
                    class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition text-xs font-semibold shadow ml-2"
                    data-action="click->horarios#adicionarHorario"
                    data-dia="<%= dia_key %>">
                    Adicionar horário (JS)
                  </button>
                </div>
                <ul id="lista-horarios-<%= dia_key %>" class="mt-2 flex flex-wrap gap-2">
                  <% ah = @patient.available_hours
                     if ah.is_a?(String)
                       begin
                         ah = JSON.parse(ah) rescue {}
                       rescue
                         ah = {}
                       end
                     end
                     if ah.is_a?(Array)
                       ah = { "all_days" => ah }
                     end
                     ah = {} unless ah.is_a?(Hash)
                     lista = Array(ah[dia_key])
                  %>
                  <% lista.each do |intervalo| %>
                    <li class="flex items-center bg-green-100 text-green-900 rounded px-3 py-1 mb-1 font-semibold text-xs shadow-sm">
                      <span><%= intervalo %></span>
                      <input type="hidden" name="patient[available_hours][<%= dia_key %>][]" value="<%= intervalo %>">
                      <button type="button" onclick="this.parentElement.remove()" class="ml-2 text-red-600 hover:text-red-800 font-bold text-lg bg-transparent border-none cursor-pointer">&times;</button>
                    </li>
                  <% end %>
                </ul>
              </div>
            <% end %>
          </div>
          <small class="text-gray-500 block mt-2">Digite o horário de início e fim no formato 12:00, 14:00. O intervalo será salvo ao criar ou editar o paciente.</small>
        </div>

        <div class="form-actions mt-12 flex justify-center">
          <button type="submit" class="bg-indigo-600 text-white px-10 py-4 rounded-lg hover:bg-indigo-700 text-xl font-bold shadow transition">Salvar</button>
        </div>
      </div>
    <% end %>

    <div class="mt-10 flex justify-center">
      <%= link_to 'Voltar para pacientes', patients_path, class: 'text-primary font-semibold hover:underline hover:text-secondary transition' %>
    </div>
  </div>
</main>