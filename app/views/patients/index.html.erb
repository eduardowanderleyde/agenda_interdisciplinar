<% if notice.present? %>
  <p class="text-green-700 bg-green-100 px-4 py-2 rounded mb-4"><%= notice %></p>
<% end %>


<div class="max-w-5xl mx-auto py-8">
  <div class="flex items-center justify-between mb-8">
    <h1 class="text-4xl font-bold text-gray-900">Pacientes</h1>
    <%= link_to "+ Novo Paciente", new_patient_path, class: "bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-5 py-2 rounded shadow" %>
  </div>
  <div class="bg-white rounded-xl shadow overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data de Nascimento</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Responsável</th>
          <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Disponível essa semana</th>
          <th class="px-6 py-3"></th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-100">
        <% @patients.each do |patient| %>
          <tr>
            <td class="px-6 py-4 whitespace-nowrap font-semibold text-gray-800"><%= patient.name %></td>
            <td class="px-6 py-4 whitespace-nowrap text-gray-700"><%= l(patient.birthdate, format: :default, locale: :'pt-BR') %></td>
            <td class="px-6 py-4 whitespace-nowrap text-gray-700"><%= patient.responsible.presence || '-' %></td>
            <td class="px-6 py-4 text-center">
              <div class="inline-flex items-center gap-2">
                <%= check_box_tag "available_this_week_#{patient.id}", 1, patient.available_this_week, data: { patient_id: patient.id }, class: "available-this-week-checkbox h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" %>
                <span class="text-green-600 text-xs font-semibold saved-feedback" id="saved-feedback-<%= patient.id %>" style="display:none;">Salvo!</span>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <%= link_to "Ver detalhes", patient, class: "bg-white border border-gray-300 rounded px-3 py-1 text-sm font-medium text-gray-900 hover:bg-gray-50" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  <div class="mt-4">
      <%= raw(pagy_bootstrap_nav(@pagy)) %>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.available-this-week-checkbox').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      const patientId = this.dataset.patientId;
      const checked = this.checked ? 1 : 0;
      fetch(`/patients/${patientId}/available_this_week`, {
        method: 'PATCH',
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name=\'csrf-token\']').content,
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ available_this_week: checked })
      }).then(() => {
        const feedback = document.getElementById(`saved-feedback-${patientId}`);
        if (feedback) {
          feedback.style.display = 'inline';
          setTimeout(() => { feedback.style.display = 'none'; }, 1200);
        }
      });
    });
  });
});
</script>
